<div class="container-fluid p-0 d-flex h-100">
  <app-dynamic-menus></app-dynamic-menus>

  <div class="bg-light flex-fill overflow-y-auto">
    <!-- Mobile Header -->
    <div class="mobile-header d-md-none d-flex text-white bg-success align-items-center">
      <a href="dashboard" class="text-white" data-bs-toggle="offcanvas" data-bs-target="#bdSidebar">
        <i class="fa-solid fa-bars"></i>
      </a>
      <span class="ms-3">Data Kavach</span>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Loading State -->
      <div *ngIf="isLoading" class="loading-state">
        <h3>Loading user data...</h3>
      </div>

      <!-- Main UI -->
      <div *ngIf="!isLoading">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg bg-body-tertiary">
          <div class="container-fluid">
            <a class="navbar-brand" href="dashboard">
              Welcome: {{ userSessionDetails?.username || 'Guest' }}
            </a>
          </div>
        </nav>
        <hr class="divider">

        <!-- Debug Info -->
        <div class="debug-info" *ngIf="userSessionDetails">
          <p><strong>Retention Needed:</strong> {{ retentionNeeded }} ({{ retentionNeeded === 0 ? 'Manual Upload' : retentionNeeded === 1 ? 'Scheduled Backup' : 'Scheduled Backup with Retention' }})</p>
          <p><strong>User Session Details:</strong> {{ userSessionDetails | json }}</p>
          <button type="button" (click)="fetchUserDetails()" [disabled]="isFetchingUserDetails">Refresh User Data</button>
          <button type="button" (click)="toggleRetentionNeeded()">Toggle Retention Needed</button>
        </div>

        <!-- Upload Section -->
        <div class="row">
          <div class="container">
            <div *ngIf="userSessionDetails" class="upload-container">
              <h2>Add Backup</h2>

              <!-- Form -->
              <form>
                <div class="form-group">
                  <label>User Email:</label>
                  <input type="text" [value]="userSessionDetails.username" disabled>
                </div>

                <div class="form-group">
                  <label for="folderName">Select Folder:</label>
                  <select id="folderName" [(ngModel)]="folderName" name="folderName" required (change)="onFolderChange()">
                    <option value="" disabled selected>Select a folder</option>
                    <option *ngFor="let folder of userFolders" [value]="folder">{{ folder }}</option>
                  </select>
                  <small *ngIf="userFolders.length === 0">No folders available. Please create a folder in OneDrive or contact your administrator.</small>
                </div>

                <div class="form-group">
                  <label for="fileName">File Name:</label>
                  <input type="text" id="fileName" [(ngModel)]="fileName" name="fileName" placeholder="e.g., myfile.txt" required
                         (input)="validateFileNameInput()">
                  <div *ngIf="fileNameError" class="error-message">{{ fileNameError }}</div>
                </div>

                <div class="form-group" *ngIf="retentionNeeded === 1 || retentionNeeded === 2">
                  <label for="localPath">Local File/Folder Path:</label>
                  <input type="text" id="localPath" [(ngModel)]="localPath" name="localPath" placeholder="e.g., C:\path\to\file or C:\path\to\folder" required>
                  <small>Enter the full path to the file or folder to back up.</small>
                </div>

                <div class="form-group" *ngIf="retentionNeeded === 1 || retentionNeeded === 2">
                  <label for="backupTime">Backup Time (HH:mm):</label>
                  <input type="time" id="backupTime" [(ngModel)]="backupTime" name="backupTime" required>
                </div>

                <div class="form-group" *ngIf="retentionNeeded === 1 || retentionNeeded === 2">
                  <label for="retentionDays">Retention Days:</label>
                  <input type="number" id="retentionDays" [(ngModel)]="retentionDays" name="retentionDays" min="1" value="7" required>
                </div>

                <div class="form-group" *ngIf="retentionNeeded === 1 || retentionNeeded === 2">
                  <label for="backupFrequency">Backup Frequency:</label>
                  <select id="backupFrequency" [(ngModel)]="backupFrequency" name="backupFrequency" (change)="onFrequencyChange()">
                    <option value="Daily">Daily</option>
                    <option value="Weekly">Weekly</option>
                    <option value="Monthly">Monthly</option>
                  </select>
                </div>

                <div class="form-group" *ngIf="backupFrequency === 'Weekly' && (retentionNeeded === 1 || retentionNeeded === 2)">
                  <label for="dayOfWeek">Day of Week:</label>
                  <select id="dayOfWeek" [(ngModel)]="dayOfWeek" name="dayOfWeek" required>
                    <option value="MONDAY">Monday</option>
                    <option value="TUESDAY">Tuesday</option>
                    <option value="WEDNESDAY">Wednesday</option>
                    <option value="THURSDAY">Thursday</option>
                    <option value="FRIDAY">Friday</option>
                    <option value="SATURDAY">Saturday</option>
                    <option value="SUNDAY">Sunday</option>
                  </select>
                </div>

                <div class="form-group" *ngIf="backupFrequency === 'Monthly' && (retentionNeeded === 1 || retentionNeeded === 2)">
                  <label for="dayOfMonth">Day of Month:</label>
                  <input type="number" id="dayOfMonth" [(ngModel)]="dayOfMonth" name="dayOfMonth" min="1" max="31" placeholder="e.g., 1" required>
                </div>

                <div class="form-group">
                  <label for="fileInput">
                    Select Files {{ (retentionNeeded === 1 || retentionNeeded === 2) ? '(Optional for Initial Upload)' : '(Required)' }}:
                  </label>
                  <input type="file" id="fileInput" (change)="onFilesSelected($event)" name="fileInput" multiple>
                  <small *ngIf="selectedFiles.length > 0">Selected: {{ selectedFiles.length }} file(s)</small>
                </div>

                <!-- Buttons -->
                <div class="button-group">
                  <button type="button" (click)="onCreateSchedule()" [disabled]="!isScheduleFormValid() || scheduling || fileNameError || userFolders.length === 0">
                    {{ (retentionNeeded === 1 || retentionNeeded === 2) ? (scheduling ? 'Creating Schedule...' : 'Create Backup Schedule') : (uploading ? 'Uploading...' : 'Upload Files') }}
                  </button>
                  <button type="button" *ngIf="retentionNeeded === 1 || retentionNeeded === 2" (click)="onUpload()" [disabled]="!folderName || uploading || fileNameError || userFolders.length === 0">
                    {{ uploading ? 'Uploading...' : 'Upload Files' }}
                  </button>
                </div>

                <!-- Progress Bars -->
                <div *ngIf="overallProgress > 0" class="progress-bar">
                  <div class="progress" [style.width]="overallProgress + '%'">
                    Overall: {{ overallProgress }}% (File {{ currentFileIndex + 1 }} of {{ selectedFiles.length }})
                  </div>
                </div>
                <div *ngIf="chunkProgress > 0 && uploading" class="progress-bar">
                  <div class="progress" [style.width]="chunkProgress + '%'">
                    Chunk: {{ chunkProgress }}%
                  </div>
                </div>

                <!-- Messages -->
                <div *ngIf="message" class="message" [ngClass]="{'success': isSuccess, 'error': !isSuccess}">
                  <i [ngClass]="isSuccess ? 'fa-solid fa-check-circle' : 'fa-solid fa-exclamation-circle'"></i>
                  {{ message }}
                </div>
              </form>

              <!-- File List -->
              <div class="file-list">
                <h3>Files in {{ folderName || 'Selected Folder' }}</h3>
                <div *ngIf="isFilesLoading" class="loading-state">
                  <p>Loading files...</p>
                </div>
                <div *ngIf="!isFilesLoading">
                  <div class="file-grid" *ngIf="files.length > 0">
                    <div *ngFor="let file of files" class="file-item">
                      <div class="file-info">
                        <div><strong>Name:</strong> {{ file.name }}</div>
                        <div><strong>ID:</strong> {{ file.id }}</div>
                        <div><strong>Download:</strong> <a [href]="file.downloadUrl" target="_blank">Download</a></div>
                      </div>
                    </div>
                  </div>
                  <p *ngIf="files.length === 0 && folderName" class="no-files">
                    No files found in the selected folder.
                  </p>
                  <div class="pagination" *ngIf="nextLink">
                    <button (click)="loadFiles(nextLink)" [disabled]="isFilesLoading">Load More Files</button>
                  </div>
                </div>
              </div>

              <!-- Backup List -->
              <div *ngIf="retentionNeeded === 1 || retentionNeeded === 2" class="backup-list">
                <h3>Scheduled Backups</h3>
                <div *ngIf="isSchedulesLoading" class="loading-state">
                  <p>Loading backup schedules...</p>
                </div>
                <div *ngIf="!isSchedulesLoading">
                  <div class="backup-grid" *ngIf="backupSchedules.length > 0">
                    <div *ngFor="let schedule of backupSchedules" class="backup-item">
                      <div class="backup-info">
                        <div><strong>Schedule ID:</strong> {{ schedule.scheduleId }}</div>
                        <div><strong>Path:</strong> {{ schedule.filePath }}</div>
                        <div><strong>Local Path:</strong> {{ schedule.localFilePath }}</div>
                        <div>
                          <strong>Frequency:</strong> {{ schedule.backupFrequency }}
                          <span *ngIf="schedule.backupFrequency === 'Weekly'"> ({{ schedule.dayOfWeek }})</span>
                          <span *ngIf="schedule.backupFrequency === 'Monthly'"> (Day {{ schedule.dayOfMonth }})</span>
                        </div>
                        <div><strong>Time:</strong> {{ schedule.backupTime }}</div>
                        <div><strong>Retention Days:</strong> {{ schedule.retentionDays }}</div>
                        <div><strong>Last Backup:</strong> {{ schedule.lastBackupTime ? (schedule.lastBackupTime | date:'medium') : 'N/A' }}</div>
                        <div><strong>Next Run:</strong> {{ schedule.nextBackupTime | date:'medium' }}</div>
                        <div><strong>Status:</strong> {{ schedule.isActive ? 'Active' : 'Inactive' }}</div>
                        <div *ngIf="schedule.lastError" class="error-message">
                          <strong>Last Error:</strong> {{ schedule.lastError }}
                        </div>
                      </div>
                      <button (click)="triggerManualBackup(schedule.scheduleId)" [disabled]="!schedule.isActive">
                        Run Now
                      </button>
                    </div>
                  </div>
                  <p *ngIf="backupSchedules.length === 0" class="no-schedules">
                    No backup schedules found. Create a new schedule above or contact your administrator if you expect existing schedules.
                  </p>
                </div>
              </div>
            </div>

            <!-- Fallback Message -->
            <div *ngIf="!userSessionDetails" class="error">
              No valid user session found. Please log in again.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>