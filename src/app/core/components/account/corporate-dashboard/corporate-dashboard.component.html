<div class="container-fluid p-0 d-flex h-100">
  <app-dynamic-menus></app-dynamic-menus>

  <div class="bg-light flex-fill">
    <!-- Mobile Sidebar Toggle -->
    <div class="p-2 d-md-none d-flex text-white bg-gradient bg-primary">
      <a href="#" class="text-white" data-bs-toggle="offcanvas" data-bs-target="#bdSidebar">
        <i class="fa-solid fa-bars"></i>
      </a>
      <span class="ms-3 fw-bold">Data Kavach</span>
    </div>

    <div class="p-4">
      <!-- Navbar with Username -->
      <nav class="navbar navbar-expand-lg bg-white shadow-sm rounded">
        <div class="container-fluid">
          <span class="navbar-brand fw-semibold text-muted" style="font-size: 14px;">
            Welcome, {{userSessionDetails?.username}}
          </span>
        </div>
      </nav>

      <hr class="my-4">

      <div class="row">
        <div class="col">
          <!-- OneDrive Folders Section -->
          <h2 class="text-center mb-4 fw-bold text-primary">Folder Explorer</h2>

          <!-- Storage Overview -->
          <div class="card shadow-sm p-4 mb-4 bg-white rounded">
            <div class="row align-items-center">
              <div class="col-md-6">
                <h5 class="fw-semibold text-dark">Storage Overview</h5>
                <p class="text-muted">Total Used: {{ formatSize(totalSize) }} / 1 TB</p>
                <p class="text-muted">Remaining: {{ formatSize(remainingStorage) }}</p>
              </div>
              <div class="col-md-6 text-center">
                <canvas id="storageChart" height="150"></canvas>
              </div>
            </div>
          </div>

          <!-- Success Message -->
          <div *ngIf="successMessage" class="alert alert-success shadow-sm rounded" role="alert" style="white-space: pre-wrap;">
            {{ successMessage }}
          </div>

          <!-- Error Message -->
          <div *ngIf="errorMessage" class="alert alert-danger shadow-sm rounded" role="alert" style="white-space: pre-wrap;">
            {{ errorMessage }}
          </div>

          <!-- Breadcrumbs and Navigation -->
          <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb bg-white p-2 rounded shadow-sm">
              <li class="breadcrumb-item">
                <a href="javascript:void(0)" class="text-primary" (click)="listRootFolders()">Root</a>
              </li>
              <li *ngFor="let pathSegment of currentPath.split('/'); let i = index" class="breadcrumb-item">
                <a href="javascript:void(0)" class="text-primary" (click)="navigateToPathSegment(i)">{{ pathSegment }}</a>
              </li>
            </ol>
          </nav>

          <!-- Back Button -->
          <button *ngIf="pathHistory.length > 0" class="btn btn-outline-primary mb-3 shadow-sm" (click)="navigateBack()">
            <i class="bi bi-arrow-left me-1"></i> Back
          </button>

          <!-- Loading Spinner -->
          <div class="text-center mt-4" *ngIf="loading">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>

          <!-- Contents Table -->
          <div class="card shadow-sm p-4 mb-4 bg-white rounded" *ngIf="!loading && oneDriveContents.length > 0">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th scope="col">Name</th>
                  <th scope="col">ID</th>
                  <th scope="col">Type</th>
                  <th scope="col">Size</th>
                  <th scope="col">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of oneDriveContents" class="hover-shadow">
                  <td>
                    <a *ngIf="item.type === 'folder'" href="javascript:void(0)" class="text-primary fw-semibold" (click)="listFolderContents(item.name)">
                      <i class="bi bi-folder-fill me-1"></i> {{ item.name }}
                    </a>
                    <span *ngIf="item.type === 'file'" class="text-dark"><i class="bi bi-file-earmark-text me-1"></i> {{ item.name }}</span>
                  </td>
                  <td>{{ item.id }}</td>
                  <td>{{ item.type | titlecase }}</td>
                  <td>{{ formatSize(item.size) }}</td>
                  <td>
                    <a *ngIf="item.type === 'file' && item.downloadUrl" [href]="item.downloadUrl" [download]="item.name" class="btn btn-primary btn-sm shadow-sm me-1">
                      <i class="bi bi-download me-1"></i> Download
                    </a>
                    <button *ngIf="item.type === 'folder'" class="btn btn-primary btn-sm shadow-sm me-1" (click)="downloadFolder(item.name)">
                      <i class="bi bi-download me-1"></i> Download Folder
                    </button>
                    <button *ngIf="item.type === 'folder'" class="btn btn-outline-secondary btn-sm shadow-sm" (click)="openRenameModal(item.name)">
                      <i class="bi bi-pencil me-1"></i> Rename
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Rename Folder Modal -->
          <div class="modal fade" id="renameModal" tabindex="-1" aria-labelledby="renameModalLabel" aria-hidden="true" [ngClass]="{'show d-block': showRenameModal}" style="background-color: rgba(0,0,0,0.5);" *ngIf="showRenameModal">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="renameModalLabel">Rename Folder: {{ selectedFolder }}</h5>
                  <button type="button" class="btn-close" (click)="closeRenameModal()" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label for="newFolderName" class="form-label">New Folder Name</label>
                    <input type="text" class="form-control" id="newFolderName" [(ngModel)]="newFolderName" placeholder="Enter new folder name" required>
                  </div>
                  <div *ngIf="renameError" class="alert alert-danger" role="alert" style="white-space: pre-wrap;">
                    {{ renameError }}
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" (click)="closeRenameModal()">Cancel</button>
                  <button type="button" class="btn btn-primary" (click)="renameFolder()" [disabled]="!newFolderName.trim()">Rename</button>
                </div>
              </div>
            </div>
          </div>

          <!-- No Folders Message -->
          <div class="card shadow-sm p-4 mb-4 bg-white rounded" *ngIf="!loading && oneDriveContents.length === 0 && !errorMessage">
            <div class="alert alert-info text-center shadow-sm" *ngIf="userSessionDetails">
              No items found in the OneDrive account for "{{userSessionDetails?.username}}" in the current folder.
            </div>
            <div class="alert alert-warning text-center shadow-sm" *ngIf="!userSessionDetails">
              Please log in to view OneDrive folders.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>